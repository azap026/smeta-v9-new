# Виртуализация таблиц

В проекте добавлен общий компонент `VirtualizedTBody` на базе `@tanstack/react-virtual`, который виртуализирует строки таблиц, не трогая `thead`. Это сохраняет липкий заголовок, колонки и выравнивание.

## Где используется
- Вкладка «Расчет сметы» — виртуализируется список стадий/подстадий и блоков работ с материалами.
- «Справочник работ» — виртуализируются группы и элементы.
- «Справочник материалов» — виртуализируются строки материалов.

## Ключевые свойства
- `rows`: массив моделей строк.
- `renderRow(row, index, ctx)`: рендер строки. Важно повесить `ref={ctx.measureRef}` на `<tr>` при динамической высоте.
- `estimateSize(row, index)`: оценка высоты строки (px).
- `getRowKey(row, index)`: стабильный ключ для строк.
- `overscan`: запас невидимых строк сверху/снизу. Значения по умолчанию вынесены в `src/virtualizationConfig.js` (`overscanDefaults`).
- `enabled`: флаг включения; при печати компонент сам отключает виртуализацию.

## Поведение в печати
Компонент автоматически отключает виртуализацию при `window.print` (используются `matchMedia('print')` и события `beforeprint/afterprint`) и рендерит полный `tbody`.

## Динамические высоты
Для строк с меняющейся высотой используйте `ctx.measureRef` на `<tr>`. Внутри компонента измерение высоты дебаунсится через `requestAnimationFrame` для стабильности. При появлении контейнера из `display:none` используется `IntersectionObserver` для переизмерения.

## Настройки
Общие значения высот строк и overscan храните в `src/virtualizationConfig.js`:
- `rowHeights`: предустановленные высоты для разных видов строк (works/materials/calc).
- `overscanDefaults`: дефолты для расчета (`calc`) и справочников (`refs`).

## Ограничения и советы
- Держите виртуализацию на уровне `<tbody>`, не переносите её на `<table>` целиком — это ломает липкие заголовки и колонки.
- При редактировании текстовых полей используйте авто-изменение высоты через `textarea` и вызов `measureRef` (уже делается автоматически через ref).
- Для печати больших таблиц учитывайте время рендера всего набора строк (виртуализация отключается специально).
